#N canvas 218 0 2320 1041 12;
#X obj 16 269 dac~ 1 2, f 49;
#X obj 139 81 r v1_trill;
#X obj 16 129 granular_sound_engine_1_sample, f 49;
#X obj 356 81 r v2_trill;
#N canvas 101 275 1315 301 v1_vals_handler 0;
#X obj 22 22 unpack f f;
#X obj 205 68 clip 0 1;
#X obj 22 -1 inlet pred;
#X obj 402 22 inlet trill;
#X obj 22 91 outlet midi_note;
#X obj 205 91 outlet vol;
#X obj 402 91 outlet grain_dur;
#X obj 22 45 cyclone/scale 0 500 45 69;
#X obj 22 68 clip 45 89;
#X obj 205 45 cyclone/scale 28 0 0 1;
#X obj 402 45 cyclone/scale 0 1 200 400;
#X text 21 117 The position in range 0-500mm is scaled linearly and continously to range 45-69 which are the interpreted as MIDI note numbers., f 18;
#X text 181 117 The displacement (or technically \, the distance between the string and the neck \, is scaled linearly to range 0-1 which maps to the volume of the voice., f 20;
#X text 386 118 The Trill output is scaled to range 200-400ms which is used to control the grain duration for the voice. This allows the user to opt for a more 'bitty' granular sound by not touching Trill strip \, or a more continous \, sustained sound by touching the Trill strip., f 28;
#X connect 0 0 7 0;
#X connect 0 1 9 0;
#X connect 1 0 5 0;
#X connect 2 0 0 0;
#X connect 3 0 10 0;
#X connect 7 0 8 0;
#X connect 8 0 4 0;
#X connect 9 0 1 0;
#X connect 10 0 6 0;
#X restore 16 105 pd v1_vals_handler;
#N canvas 391 397 1275 287 v2_vals_handler 0;
#X obj 20 37 unpack f f;
#X obj 203 83 clip 0 1;
#X obj 20 14 inlet pred;
#X obj 400 37 inlet trill;
#X obj 20 106 outlet midi_note;
#X obj 203 106 outlet vol;
#X obj 400 106 outlet grain_dur;
#X obj 20 60 cyclone/scale 0 500 45 69;
#X obj 20 83 clip 45 69;
#X obj 203 60 cyclone/scale 28 0 0 1;
#X obj 400 60 cyclone/scale 0 1 200 400;
#X text 21 138 The position in range 0-500mm is scaled linearly and continously to range 45-69 which are the interpreted as MIDI note numbers., f 18;
#X text 181 138 The displacement (or technically \, the distance between the string and the neck \, is scaled linearly to range 0-1 which maps to the volume of the voice., f 20;
#X text 386 139 The Trill output is scaled to range 200-400ms which is used to control the grain duration for the voice. This allows the user to opt for a more 'bitty' granular sound by not touching Trill strip \, or a more continous \, sustained sound by touching the Trill strip., f 28;
#X connect 0 0 7 0;
#X connect 0 1 9 0;
#X connect 1 0 5 0;
#X connect 2 0 0 0;
#X connect 3 0 10 0;
#X connect 7 0 8 0;
#X connect 8 0 4 0;
#X connect 9 0 1 0;
#X connect 10 0 6 0;
#X restore 233 105 pd v2_vals_handler;
#N canvas -488 223 1989 1041 adc_handler 0;
#X obj 18 103 adc~ 7 8 9 10;
#X obj 259 103 adc~ 3 4 5 6;
#X obj 18 318 cyclone/snapshot~ 20;
#X obj 47 295 cyclone/snapshot~ 20;
#X obj 76 272 cyclone/snapshot~ 20;
#X obj 106 249 cyclone/snapshot~ 20;
#X obj 259 318 cyclone/snapshot~ 20;
#X obj 286 295 cyclone/snapshot~ 20;
#X obj 313 272 cyclone/snapshot~ 20;
#X obj 340 249 cyclone/snapshot~ 20;
#X obj 18 472 pack f f f f, f 13;
#X obj 259 472 pack f f f f;
#X obj 259 521 outlet v2_vals;
#X obj 18 521 outlet v1_vals;
#X obj 18 249 lop~ 100;
#X obj 47 227 lop~ 100;
#X obj 76 204 lop~ 100;
#X obj 106 182 lop~ 100;
#X obj 259 250 lop~ 100;
#X obj 286 228 lop~ 100;
#X obj 313 205 lop~ 100;
#X obj 340 183 lop~ 100;
#X obj 152 104 loadbang;
#X msg 152 128 120;
#X obj 668 369 inlet scaler_list;
#X obj 668 417 unpack f f f f f f f f;
#X obj 676 393 print scaler_list;
#X obj 527 206 loadbang;
#X obj 341 379 expr $f1/$f2 * 0.68;
#X obj 313 402 expr $f1/$f2 * 0.68;
#X obj 286 425 expr $f1/$f2 * 0.68;
#X obj 259 448 expr $f1/$f2 * 0.68;
#X obj 47 425 expr $f1/$f2 * 0.68;
#X obj 76 402 expr $f1/$f2 * 0.68;
#X obj 105 379 expr $f1/$f2 * 0.68;
#X obj 18 448 expr $f1/$f2 * 0.68;
#X obj 26 496 outlet v1_calib_vals;
#X obj 26 342 pack f f f f;
#X obj 267 342 pack f f f f;
#X obj 267 496 outlet v2_calib_vals;
#X msg 527 230 0.01;
#X msg 185 128 25;
#X text 666 260 Average values from the calibration phase are received here and are then used to scale the sensor inputs based on the amount of IR light in the environment., f 25;
#X text 18 8 String 1 uses ADCs 7-10 \, while string 2 uses ADCs 3-6. Each signal is low passed at 120Hz to smooth the response of the sensors. Each sensor values is then snapshotted every 25ms \, and scaled based on the results of the calibration phase. Each string's sensors are then packed into a list \, ready for the ML prediction phase.;
#X connect 0 0 14 0;
#X connect 0 1 15 0;
#X connect 0 2 16 0;
#X connect 0 3 17 0;
#X connect 1 0 18 0;
#X connect 1 1 19 0;
#X connect 1 2 20 0;
#X connect 1 3 21 0;
#X connect 2 0 35 0;
#X connect 2 0 37 0;
#X connect 3 0 32 0;
#X connect 3 0 37 1;
#X connect 4 0 33 0;
#X connect 4 0 37 2;
#X connect 5 0 34 0;
#X connect 5 0 37 3;
#X connect 6 0 31 0;
#X connect 6 0 38 0;
#X connect 7 0 30 0;
#X connect 7 0 38 1;
#X connect 8 0 29 0;
#X connect 8 0 38 2;
#X connect 9 0 28 0;
#X connect 9 0 38 3;
#X connect 10 0 13 0;
#X connect 11 0 12 0;
#X connect 14 0 2 0;
#X connect 15 0 3 0;
#X connect 16 0 4 0;
#X connect 17 0 5 0;
#X connect 18 0 6 0;
#X connect 19 0 7 0;
#X connect 20 0 8 0;
#X connect 21 0 9 0;
#X connect 22 0 23 0;
#X connect 22 0 41 0;
#X connect 23 0 17 1;
#X connect 23 0 16 1;
#X connect 23 0 15 1;
#X connect 23 0 14 1;
#X connect 23 0 18 0;
#X connect 23 0 19 0;
#X connect 23 0 20 0;
#X connect 23 0 21 0;
#X connect 24 0 25 0;
#X connect 24 0 26 0;
#X connect 25 0 35 1;
#X connect 25 1 32 1;
#X connect 25 2 33 1;
#X connect 25 3 34 1;
#X connect 25 4 31 1;
#X connect 25 5 30 1;
#X connect 25 6 29 1;
#X connect 25 7 28 1;
#X connect 27 0 40 0;
#X connect 28 0 11 3;
#X connect 29 0 11 2;
#X connect 30 0 11 1;
#X connect 31 0 11 0;
#X connect 32 0 10 1;
#X connect 33 0 10 2;
#X connect 34 0 10 3;
#X connect 35 0 10 0;
#X connect 37 0 36 0;
#X connect 38 0 39 0;
#X connect 40 0 28 1;
#X connect 40 0 29 1;
#X connect 40 0 30 1;
#X connect 40 0 31 1;
#X connect 40 0 32 1;
#X connect 40 0 33 1;
#X connect 40 0 34 1;
#X connect 40 0 35 1;
#X connect 41 0 5 1;
#X connect 41 0 4 1;
#X connect 41 0 3 1;
#X connect 41 0 2 1;
#X connect 41 0 9 1;
#X connect 41 0 8 1;
#X connect 41 0 7 1;
#X connect 41 0 6 1;
#X restore 16 57 pd adc_handler;
#X f 49;
#N canvas 98 98 1014 736 v1_reg_model 0;
#X msg 36 150 predict \$1 \$2 \$3 \$4;
#X obj 36 198 neuralnet;
#X obj 184 150 loadbang;
#X msg 47 175 load model.ann;
#X obj 36 222 outlet predictions;
#X obj 36 127 inlet adc_vals;
#X text 35 17 The filtered and packed sensor values are received here as a message (list of 4 values) \, and are sent to the Neuralnet object to predict the position and displacement of the string. The prediction is sent out as a list of 2 values., f 37;
#X connect 0 0 1 0;
#X connect 1 0 4 0;
#X connect 2 0 3 0;
#X connect 3 0 1 0;
#X connect 5 0 0 0;
#X restore 16 81 pd v1_reg_model;
#N canvas 98 98 1014 736 v2_reg_model 0;
#X msg 37 146 predict \$1 \$2 \$3 \$4;
#X obj 37 194 neuralnet;
#X obj 185 146 loadbang;
#X msg 48 171 load model.ann;
#X obj 37 218 outlet predictions;
#X obj 37 123 inlet adc_vals;
#X text 35 17 The filtered and packed sensor values are received here as a message (list of 4 values) \, and are sent to the Neuralnet object to predict the position and displacement of the string. The prediction is sent out as a list of 2 values., f 37;
#X connect 0 0 1 0;
#X connect 1 0 4 0;
#X connect 2 0 3 0;
#X connect 3 0 1 0;
#X connect 5 0 0 0;
#X restore 233 81 pd v2_reg_model;
#N canvas 147 147 962 597 init 0;
#X obj 28 19 trill_input_handler;
#X obj 28 102 load_gran_samp;
#X obj 28 80 loadbang;
#X obj 28 43 s v2_trill;
#X obj 158 42 s v1_trill;
#X text 137 67 Contains patches that run on startup., f 14;
#X connect 0 0 3 0;
#X connect 0 1 4 0;
#X connect 2 0 1 0;
#X restore 310 33 pd init;
#N canvas 90 348 481 470 calibration 0;
#X obj 11 387 outlet calib_list;
#X obj 11 116 unpack f f f f f f f f;
#X obj 274 56 i;
#X obj 305 57 + 1;
#X obj 274 33 bng 19 250 50 0 empty empty empty 0 -10 0 12 #fcfcfc #000000 #000000;
#N canvas 294 294 362 208 mov_avg 0;
#X obj 15 11 inlet;
#X obj 15 59 cyclone/zl sum;
#X obj 15 35 cyclone/zl stream 100;
#X obj 15 83 / 100;
#X obj 15 107 outlet;
#X connect 0 0 2 0;
#X connect 1 0 3 0;
#X connect 2 0 1 0;
#X connect 3 0 4 0;
#X restore 11 315 pd mov_avg;
#N canvas 294 294 362 246 mov_avg 0;
#X obj 15 11 inlet;
#X obj 15 59 cyclone/zl sum;
#X obj 15 35 cyclone/zl stream 100;
#X obj 15 83 / 100;
#X obj 15 107 outlet;
#X connect 0 0 2 0;
#X connect 1 0 3 0;
#X connect 2 0 1 0;
#X connect 3 0 4 0;
#X restore 32 291 pd mov_avg;
#N canvas 294 294 362 284 mov_avg 0;
#X obj 15 11 inlet;
#X obj 15 59 cyclone/zl sum;
#X obj 15 35 cyclone/zl stream 100;
#X obj 15 83 / 100;
#X obj 15 107 outlet;
#X connect 0 0 2 0;
#X connect 1 0 3 0;
#X connect 2 0 1 0;
#X connect 3 0 4 0;
#X restore 54 268 pd mov_avg;
#N canvas 294 294 362 284 mov_avg 0;
#X obj 15 11 inlet;
#X obj 15 59 cyclone/zl sum;
#X obj 15 35 cyclone/zl stream 100;
#X obj 15 83 / 100;
#X obj 15 107 outlet;
#X connect 0 0 2 0;
#X connect 1 0 3 0;
#X connect 2 0 1 0;
#X connect 3 0 4 0;
#X restore 75 244 pd mov_avg;
#N canvas 294 294 362 246 mov_avg 0;
#X obj 15 11 inlet;
#X obj 15 59 cyclone/zl sum;
#X obj 15 35 cyclone/zl stream 100;
#X obj 15 83 / 100;
#X obj 15 107 outlet;
#X connect 0 0 2 0;
#X connect 1 0 3 0;
#X connect 2 0 1 0;
#X connect 3 0 4 0;
#X restore 97 221 pd mov_avg;
#N canvas 294 294 362 284 mov_avg 0;
#X obj 15 11 inlet;
#X obj 15 59 cyclone/zl sum;
#X obj 15 35 cyclone/zl stream 100;
#X obj 15 83 / 100;
#X obj 15 107 outlet;
#X connect 0 0 2 0;
#X connect 1 0 3 0;
#X connect 2 0 1 0;
#X connect 3 0 4 0;
#X restore 118 197 pd mov_avg;
#N canvas 294 294 362 284 mov_avg 0;
#X obj 15 11 inlet;
#X obj 15 59 cyclone/zl sum;
#X obj 15 35 cyclone/zl stream 100;
#X obj 15 83 / 100;
#X obj 15 107 outlet;
#X connect 0 0 2 0;
#X connect 1 0 3 0;
#X connect 2 0 1 0;
#X connect 3 0 4 0;
#X restore 140 174 pd mov_avg;
#N canvas 294 294 362 132 mov_avg 0;
#X obj 15 11 inlet;
#X obj 15 59 cyclone/zl sum;
#X obj 15 35 cyclone/zl stream 100;
#X obj 15 83 / 100;
#X obj 15 107 outlet;
#X connect 0 0 2 0;
#X connect 1 0 3 0;
#X connect 2 0 1 0;
#X connect 3 0 4 0;
#X restore 162 151 pd mov_avg;
#X obj 11 93 spigot;
#X msg 274 152 1;
#X msg 316 152 0;
#X obj 274 176 tgl 19 0 empty empty empty 0 -10 0 12 #fcfcfc #000000 #000000 0 1;
#X msg 297 33 0;
#X obj 274 80 >= 100;
#X obj 316 176 bng 19 250 50 0 empty empty empty 0 -10 0 12 #fcfcfc #000000 #000000;
#X obj 11 70 t l b;
#X obj 274 128 sel 0;
#X obj 316 128 sel 1;
#X obj 274 104 change;
#X obj 11 339 pack f f f f f f f f, f 22;
#X obj 11 363 list store;
#X obj 210 104 loadbang;
#X obj 316 200 s is_calibrated;
#X obj 11 24 inlet adc7-10;
#X obj 110 24 inlet adc3-6;
#X obj 11 47 list append;
#X text 250 237 The first 100 samples from the distance sensors after turning the Bela on are received here \, averaged for each sensor \, and then used to scale the ADC inputs. This allows the instrument to 'auto-calibrate' on startup \, which allows for better accuracy in a wide range of lighting conditions., f 24;
#X connect 1 0 5 0;
#X connect 1 1 6 0;
#X connect 1 2 7 0;
#X connect 1 3 8 0;
#X connect 1 4 9 0;
#X connect 1 5 10 0;
#X connect 1 6 11 0;
#X connect 1 7 12 0;
#X connect 2 0 3 0;
#X connect 2 0 18 0;
#X connect 3 0 2 1;
#X connect 4 0 2 0;
#X connect 5 0 24 0;
#X connect 6 0 24 1;
#X connect 7 0 24 2;
#X connect 8 0 24 3;
#X connect 9 0 24 4;
#X connect 10 0 24 5;
#X connect 11 0 24 6;
#X connect 12 0 24 7;
#X connect 13 0 1 0;
#X connect 14 0 16 0;
#X connect 15 0 19 0;
#X connect 15 0 16 0;
#X connect 16 0 13 1;
#X connect 17 0 2 0;
#X connect 18 0 23 0;
#X connect 19 0 25 0;
#X connect 19 0 27 0;
#X connect 20 0 13 0;
#X connect 20 1 4 0;
#X connect 21 0 14 0;
#X connect 22 0 15 0;
#X connect 23 0 21 0;
#X connect 23 0 22 0;
#X connect 24 0 25 1;
#X connect 25 0 0 0;
#X connect 26 0 14 0;
#X connect 28 0 30 0;
#X connect 29 0 30 1;
#X connect 30 0 20 0;
#X restore 144 33 pd calibration;
#X obj 16 153 *~;
#X obj 338 153 *~;
#N canvas 98 98 230 241 calib_mute 0;
#X obj 13 10 r is_calibrated;
#X msg 13 34 1 50;
#X obj 13 58 line~;
#X obj 127 10 loadbang;
#X msg 127 34 0;
#X obj 13 82 outlet~;
#X text 14 110 This subpatch just ensures that Bela is muted while the calibration phase is going on at startup. After the bang is sent to update the calibration values \, this received a 1 to restart audio., f 28;
#X connect 0 0 1 0;
#X connect 1 0 2 0;
#X connect 2 0 5 0;
#X connect 3 0 4 0;
#X connect 4 0 2 0;
#X restore 45 153 pd calib_mute;
#X obj 16 201 *~ 0.6;
#X obj 65 201 *~ 0.3;
#X obj 268 201 *~ 0.3;
#X obj 317 201 *~ 0.6;
#N canvas 208 208 847 475 delay 0;
#X obj 33 17 inlet~ L;
#X obj 283 15 inlet~ R;
#X obj 32 395 +~;
#X obj 32 419 outlet~ L;
#X obj 284 387 +~;
#X obj 284 411 outlet~ R;
#X obj 50 169 delwrite~ delay_buffer_L 1000;
#X obj 50 193 delread~ delay_buffer_L;
#X obj 50 328 *~;
#X obj 57 284 loadbang;
#X obj 57 351 s~ delay_buffer_L;
#X obj 57 145 r~ delay_buffer_L;
#X obj 57 97 loadbang;
#X obj 302 328 *~;
#X obj 309 284 loadbang;
#X obj 309 97 loadbang;
#X obj 309 145 r~ delay_buffer_R;
#X obj 302 169 delwrite~ delay_buffer_R 1000;
#X obj 302 193 delread~ delay_buffer_R;
#X obj 309 351 s~ delay_buffer_R;
#X obj 50 217 lop~ 500;
#X obj 50 239 lop~ 500;
#X obj 50 261 lop~ 500;
#X obj 302 217 lop~ 500;
#X obj 302 239 lop~ 500;
#X obj 302 261 lop~ 500;
#X msg 309 306 0.6;
#X msg 57 306 0.6;
#X obj 536 15 inlet trill_v1;
#X obj 670 15 inlet trill_v2;
#X msg 536 63 \$1 10;
#X msg 670 63 \$1 10;
#X obj 536 87 line~;
#X obj 670 87 line~;
#X msg 57 121 380;
#X msg 309 121 420;
#X obj 670 39 expr ($f1*0.7)+0.1;
#X obj 536 39 expr ($f1*0.7)+0.1;
#X text 541 215 Basic delay effect - both L & R low-passed \, written to their own buffers \, delayed by 380ms (L) and 420ms (R) \, and repeat. The 'feedback' of the delay (the amount that is sent on to be delayed again) is determined amount of contact on the Trill strips such that no touch=low feedback \, full touch=high feedback., f 31;
#X connect 0 0 6 0;
#X connect 0 0 2 0;
#X connect 1 0 4 0;
#X connect 1 0 17 0;
#X connect 2 0 3 0;
#X connect 4 0 5 0;
#X connect 7 0 20 0;
#X connect 8 0 10 0;
#X connect 8 0 2 1;
#X connect 9 0 27 0;
#X connect 11 0 6 0;
#X connect 12 0 34 0;
#X connect 13 0 4 1;
#X connect 13 0 19 0;
#X connect 14 0 26 0;
#X connect 15 0 35 0;
#X connect 16 0 17 0;
#X connect 18 0 23 0;
#X connect 20 0 21 0;
#X connect 21 0 22 0;
#X connect 22 0 8 0;
#X connect 23 0 24 0;
#X connect 24 0 25 0;
#X connect 25 0 13 0;
#X connect 26 0 13 1;
#X connect 27 0 8 1;
#X connect 28 0 37 0;
#X connect 29 0 36 0;
#X connect 30 0 32 0;
#X connect 31 0 33 0;
#X connect 32 0 8 1;
#X connect 33 0 13 1;
#X connect 34 0 7 0;
#X connect 35 0 18 0;
#X connect 36 0 31 0;
#X connect 37 0 30 0;
#X restore 16 177 pd delay;
#X f 49;
#X obj 220 153 r v2_trill;
#X obj 143 153 r v1_trill;
#X text 475 81 3 Scaled based on calibration;
#X text 475 48 1 Low-passed to remove noise;
#X text 475 65 2 Snapshot to convert signal rate to control rate;
#X text 474 99 4 Prediction using the regression models;
#X text 474 117 5 Predicted position and displacement scaled to correct ranges for control parameters;
#X text 476 31 During regular use \, the data flow for the sensors is:;
#X text 473 149 6 Mapping in granular synthesis engine to pitch (position) \, volume (displacement) \, and grain length (Trill);
#X text 474 181 7 LR Trill amounts control amount in delay effect;
#X connect 2 0 11 0;
#X connect 2 1 12 0;
#X connect 3 0 5 1;
#X connect 4 0 2 0;
#X connect 4 1 2 1;
#X connect 4 2 2 2;
#X connect 5 0 2 3;
#X connect 5 1 2 4;
#X connect 5 2 2 5;
#X connect 6 0 7 0;
#X connect 6 1 10 0;
#X connect 6 2 8 0;
#X connect 6 3 10 1;
#X connect 7 0 4 0;
#X connect 8 0 5 0;
#X connect 10 0 6 0;
#X connect 11 0 18 0;
#X connect 12 0 18 1;
#X connect 13 0 11 1;
#X connect 13 0 12 1;
#X connect 14 0 0 0;
#X connect 15 0 0 1;
#X connect 16 0 0 0;
#X connect 17 0 0 1;
#X connect 18 0 14 0;
#X connect 18 0 15 0;
#X connect 18 1 16 0;
#X connect 18 1 17 0;
#X connect 19 0 18 3;
#X connect 20 0 18 2;
